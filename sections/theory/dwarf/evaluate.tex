% Primarily this section should be about scientific methods and theories you need to evaluate/compare/invent to solve your problems from 1.3.
% In some cases it may be ok to describe different technologies, but the purpose is to describe something and then draw a conclusion from that.
% Example, if you decide to discuss different databases, it may be for the purpose of selecting the best type for your implementation later on (based on for example data representation, scalability, speed, etc.).
% Optimally the problems in 1.3 are not solved by anyone else yet, in which case this section needs to describe how to solve them (new algorithms, mathematical approaches, etc.).
 
% This section can have a lot of subsections (3.1, 3.2, 3.3, etc).

% TODO: Explain Evaluation of values

The process of evaluating the value of a variable is a bit complicated because there is a lot of variation.
Thus to simplify the explanation a simple example will be used to explain the main part of evaluating a variable.


Taking a look at the example in figure \ref{fig:subprogramexample} there is a function/subprogram \gls{die} with the name \emph{my\_function}(it is the \gls{die} with the tag \emph{DW\_TAG\_subprogram}).
The function has a paramter called \emph{val} which is the \gls{die} with the tag \emph{DW\_TAG\_formal\_parameter}, it is a child of the function \gls{die}.
That means that it is a parameter to the function \emph{my\_function}.
It is this parameter \emph{val} that will be used as an example of how to evaluating a variable.


\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\textwidth]{subprogram-example.png}
	\caption{An example of a subprogram and parameter \gls{DWARF} \gls{die}. This example is the output of the program \emph{objdump} run on a \gls{DWARF} file.}
	\label{fig:subprogramexample}
\end{figure}


A key thing to note is that the function \gls{die} called \emph{my\_function} has two attribute called \emph{DW\_AT\_low\_pc} and \emph{DW\_AT\_high\_pc}.
Those attributes describe the range of \gls{pc} values in which the function is executing.
There is also some other attributes in the example that will not be mention because they are not needed for determining the value of the attribute.


%Another important thing to note is that the example explained is a very simple one meaning that there is a lot more different \gls{DWARF} operation for finding the location of a variable and also a lot more different tags for the type \glspl{die}.
%All the various tags for type \glspl{die} requires a unique explanation to how it should be used thus the explanation of each one of them can be read about in the \gls{DWARF} specification \cite{dwarf}, the same goes for the different \gls{DWARF} operations.


\subsubsubsection{Finding Raw Value Location}
Examining the \gls{die} for the argument \emph{val} there is a attribute there called \emph{DW\_AT\_location}.
The value of that attribute is a number of operations, preforming these operations will give the location of the variable.


In this example the operation in the \emph{DW\_AT\_location} attribute in figure \ref{fig:subprogramexample} is \emph{DW\_OP\_fbreg $-2$}.
That operation describes that the value is stored in memory at the \emph{frame base} minus $2$(see \cite{dwarf} page 18).
The \emph{Frame base} is the addess to the first variable in the functions stack frame(see \cite{dwarf} page 56).


Currently the value of the \emph{frame base} is unknown, but the location of the \emph{frame base}  is describe in the \emph{my\_function} \gls{die}.
The location of the \emph{frame base} is also describe in a number of operation.
Those operations can be found under the attribute \emph{DW\_AT\_frame\_base}.
Looking at figure \ref{fig:subprogramexample} the \emph{frame base} location is decribe with the operation \emph{DW\_OP\_reg7}.
The operation \emph{DW\_OP\_reg7} descirbe the value is located in register $7$(see \cite{dwarf} page 27).
Thus register $7$ needs to be read to get the value of the \emph{frame base}.


Now knowing the value of the \emph{frame base} the location of the parameter val can be calculated.
As mention the location of parameter \emph{val} is the \emph{frame base} minus $2$.
Thus the value of \emph{val} can be read from the memory at address of the \emph{frame base} minus $2$.
But the value also has to be parsed into the type of \emph{val}, see section \ref{sec:parsingvalue} for how that is done.


\subsubsubsection{Parsing the Raw Value} \label{sec:parsingvalue}
Now the fist problem with parsing the raw value of the paramter \emph{val} into the correct type is knowing what type the parameter has, this is where the attibute \emph{DW\_AT\_type} comes in.
The value of the \emph{DW\_AT\_type} attribute points to a type \gls{die} \gls{tree}, which describes the type of the \gls{die}.


When it comes to the value of the \emph{DW\_AT\_type} attribute for the parameter \emph{val}
Looking at the attribute \emph{DW\_AT\_type} in figure \ref{fig:subprogramexample}  of the paramter \gls{die} \emph{val} 


Luckily \gls{DWARF} has a attribute for that called \emph{DW\_AT\_type} which value is a offset into the \gls{DWARF} section called \emph{.debug\_types}.

The \emph{val} argument \gls{die} has this attribute and as can be seen in figure \ref{fig:subprogramexample} it has the value $0x6233$ which points to the type \gls{die} seen in figure \ref{fig:basetypeexample}.
Note that the type \gls{die} in the figure has the offset $6233$ which is the same offset that the \emph{val} \gls{die} has in its type attribute.
The type \gls{die} has the tag \emph{DW\_TAG\_base\_type} which means that it a type that is built into the languages and is not defined in terms of other data types(see \cite{dwarf} page 75).
The \gls{die} also have three attributes the first one is the name attributes which in this case says that the base types name is \emph{i16}, see figure \ref{fig:basetypeexample}.
Then there is the attribute \emph{DW\_AT\_encoding} describes how the raw bytes should be interpreted and in this case it has the value $5$ that stands for signed.
Thus from the encoding attribute it is known that the type of \emph{val} is a signed integer, but the size of the integer is still unknown.
The last attribute in the \gls{die} is \emph{DW\_AT\_byte\_size} and it has the value $2$ which means that the size of the signed integer is $2$ bytes.
Now the location, size and type of \emph{val} is known and thus the value can be evaluated.


\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\textwidth]{basetype-example.png}
	\caption{An example of a base type \gls{DWARF} \gls{die}. This example is the output of the program \emph{objdump} run on a \gls{DWARF} file.}
	\label{fig:basetypeexample}
\end{figure}

